# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: sdrterm

on: [push]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        WD=$(pwd);
        echo $WD;
        sudo apt-get update;
        sudo apt-get install wget sox socat unzip git make cmake libitpp-dev libsndfile1-dev portaudio19-dev coreutils sed -y;
        cd /tmp;
        git clone https://github.com/szechyjs/mbelib.git
        cd mbelib && mkdir build && cd build && cmake .. && make -j$(nproc) && sudo make install;
        cd /tmp;
        git clone https://github.com/szechyjs/dsd.git;
        cd dsd && mkdir build && cd build && cmake .. && make -j$(nproc) && sudo make install;
        cd $WD;
        python -m pip install --upgrade pip
        PIP_NO_BINARY="" pip install . --upgrade
        pip install flake8 pytest --upgrade
        chmod +x example.sh;
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 src/ --count --exit-zero --max-line-length=127 --statistics --ignore E741,F811
    - name: Test with pytest
      run: |
        cd src/
        python -m pytest ../test
        cd ..
    - name: Run functionality tests
      run: |
        export OUT_PATH=/tmp;
        export DSD_CMD="dsd -q -i - -o /dev/null -n";
        export SDRTERM_EXEC="${WD}/src/sdrterm.py";

        declare -A sums;
        sums["${OUT_PATH}/outB.wav"]="ba12b0bddc0496c7926c21bd89574a0a";
        sums["${OUT_PATH}/outd-B.wav"]="15232187d1e2edc76e9a3f6b4cf8288f";
        sums["${OUT_PATH}/outd.wav"]="15232187d1e2edc76e9a3f6b4cf8288f";
        sums["${OUT_PATH}/outf-B.wav"]="a1a2a4a87cc5c26882527f794b5879a3";
        sums["${OUT_PATH}/outf.wav"]="a1a2a4a87cc5c26882527f794b5879a3";
        sums["${OUT_PATH}/outh-B.wav"]="9617f6cf9e88cb291cf52416d32e1216";
        sums["${OUT_PATH}/outh.wav"]="9617f6cf9e88cb291cf52416d32e1216";
        sums["${OUT_PATH}/outi-B.wav"]="a1a2a4a87cc5c26882527f794b5879a3";
        sums["${OUT_PATH}/outi.wav"]="a1a2a4a87cc5c26882527f794b5879a3";
        sums["${OUT_PATH}/outi16.wav"]="b7b7a07c4d65f1b5c8020730480a6156";
        sums["${OUT_PATH}/outu8.wav"]="a4344edc3f13c1036b347c1351923129";
        sums["${OUT_PATH}/outi16X.wav"]="b7b7a07c4d65f1b5c8020730480a6156";

        wget https://www.sigidwiki.com/images/f/f5/DMR.zip && unzip DMR.zip && rm DMR.zip;
        ./example.sh SDRSharp_20160101_231914Z_12kHz_IQ.wav;
        
        declare -A z="( `sed -E "s/^((\d|\w)+)\s*((\d|\w|\/|\-|\.)+)$/[\3]=\1/g" <<< $(md5sum ${OUT_PATH}/*.wav)` )";
        for i in "${!sums[@]}"; do
          if [[ "${sums["$i"]}" == "${z["$i"]}" ]]; then
            echo "checksum matched: ${i}"
          else
            printf "${setBlue}FAILED: ${i}\n\tEXPECTED: ${sums["$i"]}\n\tRECEIVED: ${z["$i"]}\n${setNormal}" 1>&2;
          fi
        done